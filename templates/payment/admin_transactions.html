{% extends "base.html" %}

{% block title %}Payment Transactions - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .admin-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #007bff;
    }

    .admin-header h1 {
        margin: 0;
        color: #333;
    }

    .admin-filters {
        background: white;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .filter-group select,
    .filter-group input {
        padding: 10px;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        font-size: 14px;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    /* Transactions Table */
    .transactions-table {
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .table-responsive {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead tr {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background 0.3s ease;
    }

    tbody tr:hover {
        background: #f8f9fa;
    }

    td {
        padding: 15px;
        color: #333;
        font-size: 14px;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-completed {
        background: #d4edda;
        color: #155724;
    }

    .status-failed {
        background: #f8d7da;
        color: #721c24;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-refunded {
        background: #d1ecf1;
        color: #0c5460;
    }

    .gateway-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        background: #e9ecef;
        color: #495057;
    }

    .amount {
        font-weight: 600;
        color: #007bff;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-view {
        background: #007bff;
        color: white;
    }

    .btn-view:hover {
        background: #0056b3;
    }

    .btn-refund {
        background: #dc3545;
        color: white;
    }

    .btn-refund:hover {
        background: #c82333;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        text-decoration: none;
        color: #007bff;
        transition: all 0.3s ease;
    }

    .pagination a:hover {
        background: #007bff;
        color: white;
    }

    .pagination .active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 6px;
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
        color: #666;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 5px;
        text-transform: uppercase;
    }

    .stat-value {
        color: #007bff;
        font-size: 24px;
        font-weight: bold;
    }

    /* No results */
    .no-results {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .no-results i {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Admin Header -->
    <div class="admin-header">
        <div>
            <h1>üí≥ Payment Transactions</h1>
            <p style="margin: 10px 0 0 0; color: #666;">Manage and monitor all payment transactions</p>
        </div>
        <div style="text-align: right;">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="admin-filters">
        <form method="GET" id="filterForm">
            <!-- Search Row -->
            <div class="filter-row">
                <div class="filter-group" style="grid-column: span 2;">
                    <label for="search">Search (Order #, Customer Email, Transaction ID):</label>
                    <input type="text" name="search" id="search" placeholder="Enter order number, email, or transaction ID..." value="{{ search_query or '' }}">
                </div>
            </div>

            <!-- Filter Row 1 -->
            <div class="filter-row">
                <div class="filter-group">
                    <label for="gateway">Payment Gateway:</label>
                    <select name="gateway" id="gateway">
                        <option value="">All Gateways</option>
                        <option value="stripe" {% if current_gateway == 'stripe' %}selected{% endif %}>Stripe</option>
                        <option value="payfast" {% if current_gateway == 'payfast' %}selected{% endif %}>PayFast</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="status">Transaction Status:</label>
                    <select name="status" id="status">
                        <option value="">All Statuses</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>Failed</option>
                        <option value="refunded" {% if current_status == 'refunded' %}selected{% endif %}>Refunded</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort">Sort By:</label>
                    <select name="order_by" id="sort">
                        <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Date (Newest First)</option>
                        <option value="amount" {% if current_sort == 'amount' %}selected{% endif %}>Amount (Highest First)</option>
                        <option value="status" {% if current_sort == 'status' %}selected{% endif %}>Status</option>
                    </select>
                </div>
            </div>

            <!-- Date Range Row -->
            <div class="filter-row">
                <div class="filter-group">
                    <label for="date_from">From Date:</label>
                    <input type="date" name="date_from" id="date_from" value="{{ date_from or '' }}">
                </div>

                <div class="filter-group">
                    <label for="date_to">To Date:</label>
                    <input type="date" name="date_to" id="date_to" value="{{ date_to or '' }}">
                </div>
            </div>

            <div class="filter-buttons">
                <button type="submit" class="btn btn-primary">üîç Apply Filters</button>
                <a href="{{ url_for('payment.admin_transactions_list') }}" class="btn btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <!-- Bulk Actions Section -->
    <div class="admin-filters" id="bulkActionsSection" style="display: none; background: #f0f8ff;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <input type="checkbox" id="selectAll"> 
                <span id="selectionCount">0 selected</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="exportSelected()">üì• Export CSV</button>
                <button type="button" class="btn btn-secondary" onclick="checkStatusSelected()">üìä Check Status</button>
            </div>
        </div>
    </div>

    <div class="transactions-table">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="selectAllTransactions(this)"></th>
                        <th>Transaction ID</th>
                        <th>Order</th>
                        <th>Gateway</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions.items %}
                    <tr class="transaction-row">
                        <td style="width: 40px;"><input type="checkbox" class="transaction-checkbox" value="{{ tx.id }}" onchange="updateSelectionCount()"></td>
                        <td>
                            <strong>#{{ tx.payment_reference[:16] }}</strong>
                            {% if tx.payment_reference|length > 16 %}
                            <small style="color: #999;">{{ tx.payment_reference[16:] }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('customer.view_order', order_id=tx.order_id) }}" style="color: #007bff; text-decoration: none;">
                                Order #{{ tx.order.order_number }}
                            </a>
                        </td>
                        <td>
                            <span class="gateway-badge">{{ tx.payment_method|upper }}</span>
                        </td>
                        <td class="amount">${{ "%.2f"|format(tx.amount) }}</td>
                        <td>
                            <span class="status-badge status-{{ tx.status }}">
                                {{ tx.status|upper }}
                            </span>
                        </td>
                        <td>
                            <small>{{ tx.created_at.strftime('%b %d, %Y') }}<br>{{ tx.created_at.strftime('%I:%M %p') }}</small>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('payment.admin_transaction_detail', tx_id=tx.id) }}" class="btn-small btn-view">
                                    View
                                </a>
                                {% if tx.status == 'completed' and tx.payment_method == 'stripe' %}
                                <button onclick="showRefundForm({{ tx.id }}, '{{ tx.payment_reference }}', {{ tx.amount }})" class="btn-small btn-refund">
                                    Refund
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if transactions.pages > 1 %}
    <div class="pagination">
        {% if transactions.has_prev %}
        <a href="{{ url_for('payment.admin_transactions_list', page=transactions.prev_num, gateway=current_gateway, status=current_status, order_by=current_sort) }}">‚Üê Previous</a>
        {% endif %}

        {% for page_num in transactions.iter_pages(left_edge=1, right_edge=2, left_margin=0, right_margin=0) %}
            {% if page_num %}
                {% if page_num == transactions.page %}
                <span class="active">{{ page_num }}</span>
                {% else %}
                <a href="{{ url_for('payment.admin_transactions_list', page=page_num, gateway=current_gateway, status=current_status, order_by=current_sort) }}">{{ page_num }}</a>
                {% endif %}
            {% else %}
            <span>...</span>
            {% endif %}
        {% endfor %}

        {% if transactions.has_next %}
        <a href="{{ url_for('payment.admin_transactions_list', page=transactions.next_num, gateway=current_gateway, status=current_status, order_by=current_sort) }}">Next ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- No Results -->
    <div class="no-results">
        <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;">üí≥</div>
        <h3 style="color: #333;">No Transactions Found</h3>
        <p>There are no transactions matching your filters. Try adjusting your search criteria.</p>
        <a href="{{ url_for('payment.admin_transactions_list') }}" class="btn btn-primary" style="margin-top: 15px;">Reset Filters</a>
    </div>
    {% endif %}
</div>

<!-- Refund Modal (optional, can be expanded) -->
<script>
// Bulk action functions
function selectAllTransactions(checkbox) {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelectionCount();
}

function updateSelectionCount() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    const bulkSection = document.getElementById('bulkActionsSection');
    const countSpan = document.getElementById('selectionCount');
    
    if (checked > 0) {
        bulkSection.style.display = 'block';
        countSpan.textContent = `${checked} selected`;
    } else {
        bulkSection.style.display = 'none';
        countSpan.textContent = '0 selected';
    }
}

function getSelectedTransactionIds() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value).join(',');
}

function exportSelected() {
    const selectedIds = getSelectedTransactionIds();
    
    if (!selectedIds) {
        alert('Please select at least one transaction');
        return;
    }
    
    fetch('/payment/admin/transactions/bulk-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            action: 'export',
            transaction_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create CSV download
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(data.data));
            element.setAttribute('download', data.filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            alert('CSV exported successfully');
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(err => {
        alert(`Error exporting: ${err.message}`);
    });
}

function checkStatusSelected() {
    const selectedIds = getSelectedTransactionIds();
    
    if (!selectedIds) {
        alert('Please select at least one transaction');
        return;
    }
    
    fetch('/payment/admin/transactions/bulk-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            action: 'status-check',
            transaction_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const summary = data.statuses;
            const message = `Status Summary (${data.total} transactions):\n\n` +
                `‚úÖ Completed: ${summary.completed}\n` +
                `‚è≥ Pending: ${summary.pending}\n` +
                `‚ùå Failed: ${summary.failed}\n` +
                `üí∞ Refunded: ${summary.refunded}`;
            alert(message);
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(err => {
        alert(`Error checking status: ${err.message}`);
    });
}

function showRefundForm(txId, paymentRef, amount) {
    const reason = prompt('Enter refund reason:', 'Customer request');
    
    if (reason === null) {
        return; // User cancelled
    }

    const refundAmount = prompt(`Enter refund amount (max $${amount.toFixed(2)}):`, amount.toFixed(2));
    
    if (refundAmount === null) {
        return; // User cancelled
    }

    // Submit refund request
    fetch(`/payment/admin/transactions/${txId}/refund`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            amount: refundAmount,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Refund processed successfully. Refund ID: ${data.refund_id}`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(err => {
        alert(`Error processing refund: ${err.message}`);
    });
}
</script>

{% endblock %}
