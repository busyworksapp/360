{% extends "payment/base.html" %}

{% block title %}Stripe Checkout - Barron CMS{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
    /* Stripe Elements D365 Styling */
    .StripeElement {
        padding: 8px 12px;
        border: 1px solid #8a8886;
        border-radius: 2px;
        font-size: 14px;
        background: white;
        transition: all 0.2s ease;
    }

    .StripeElement--focus {
        border-color: #0078d4;
        outline: none;
    }

    .StripeElement--invalid {
        border-color: #a80000;
    }

    .card-error {
        color: #a80000;
        font-size: 11px;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-error i {
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb-d365">
        <a href="{{ url_for('home') }}">Home</a>
        <span class="separator">/</span>
        <a href="{{ url_for('payment.select_payment_method') }}">Payment Method</a>
        <span class="separator">/</span>
        <span>Stripe Checkout</span>
    </div>

    <!-- Page Title -->
    <h1 class="page-title-d365">ðŸ’³ Stripe Checkout</h1>

    <!-- Order Summary Card -->
    {% if order %}
    <div class="d365-card">
        <div class="card-header-d365">
            <h2>Order Summary</h2>
        </div>
        <div class="order-summary">
            <div class="order-summary-item">
                <span class="order-summary-label">Order Number:</span>
                <span class="order-summary-value">#{{ order.order_number }}</span>
            </div>
            <div class="order-summary-item">
                <span class="order-summary-label">Items:</span>
                <span class="order-summary-value">{{ order.order_items|length }} item(s)</span>
            </div>
            <div class="order-summary-item">
                <span class="order-summary-label">Subtotal:</span>
                <span class="order-summary-value">${{ "%.2f"|format(order.subtotal) }}</span>
            </div>
            {% if order.tax_amount %}
            <div class="order-summary-item">
                <span class="order-summary-label">Tax:</span>
                <span class="order-summary-value">${{ "%.2f"|format(order.tax_amount) }}</span>
            </div>
            {% endif %}
            {% if order.shipping_cost %}
            <div class="order-summary-item">
                <span class="order-summary-label">Shipping:</span>
                <span class="order-summary-value">${{ "%.2f"|format(order.shipping_cost) }}</span>
            </div>
            {% endif %}
            <div class="order-summary-total">
                <span>Total Amount:</span>
                <span>${{ "%.2f"|format(order.total_amount) }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Messages -->
    <div id="errorMessage" class="alert-d365 alert-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <div>
            <strong>Error:</strong> <span id="errorText"></span>
        </div>
        <button class="alert-close" onclick="this.parentElement.style.display='none';">&times;</button>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="alert-d365 alert-success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <div>
            <strong>Success!</strong> Your payment has been processed successfully. Redirecting...
        </div>
    </div>

    <!-- Payment Form Card -->
    <div class="d365-card">
        <div class="card-header-d365">
            <h2>Payment Details</h2>
            <p>Enter your card information securely</p>
        </div>
        <div class="card-body-d365">
            <form method="POST" id="payment-form" class="payment-form">
                <input type="hidden" name="order_id" value="{{ order.id if order else '' }}">
                
                <!-- Cardholder Name -->
                <div class="form-group">
                    <label for="cardholderName">Cardholder Name</label>
                    <input type="text" id="cardholderName" placeholder="John Doe" required>
                </div>

                <!-- Stripe Card Element -->
                <div class="form-group">
                    <label for="card-element">Card Details</label>
                    <div id="card-element" class="StripeElement"></div>
                    <div id="card-errors" class="card-error" role="alert"></div>
                </div>

                <!-- Billing Information -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #edebe9;">
                    <h3 style="font-size: 14px; font-weight: 600; color: #323130; margin: 0 0 16px 0;">
                        Billing Information
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" placeholder="john@example.com" value="{{ current_user.email if current_user else '' }}" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" placeholder="+1 (555) 123-4567">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address" placeholder="123 Main Street" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" placeholder="New York" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State/Province</label>
                            <input type="text" id="state" placeholder="NY" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="zip">ZIP/Postal Code</label>
                            <input type="text" id="zip" placeholder="10001" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" placeholder="United States" value="United States" required>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group" style="margin-top: 24px;">
                    <button type="button" class="btn-d365 btn-d365-secondary" onclick="window.history.back();">
                        Cancel
                    </button>
                    <button type="submit" class="btn-d365 btn-d365-primary" id="submit-button">
                        <span id="button-text">Pay ${{ "%.2f"|format(order.total_amount if order else 0) }}</span>
                        <span id="spinner" class="spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Info -->
    <div class="security-info">
        <i class="fas fa-lock"></i>
        <span>ðŸ”’ Secure payment powered by Stripe. Your card details are encrypted and never stored.</span>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    
    // Style for Stripe Elements to match D365
    const style = {
        base: {
            fontSize: '14px',
            color: '#323130',
            fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
            '::placeholder': {
                color: '#a19f9d',
            },
        },
        invalid: {
            color: '#a80000',
            iconColor: '#a80000',
        },
    };
    
    // Create card element
    const cardElement = elements.create('card', { style: style });
    cardElement.mount('#card-element');
    
    // Handle real-time validation errors
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.innerHTML = '<i class="fas fa-exclamation-triangle"></i>' + event.error.message;
        } else {
            displayError.textContent = '';
        }
    });
    
    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        
        // Disable button and show spinner
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';
        
        // Get billing details
        const billingDetails = {
            name: document.getElementById('cardholderName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: {
                line1: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postal_code: document.getElementById('zip').value,
                country: document.getElementById('country').value,
            },
        };
        
        // Create payment method
        const {paymentMethod, error} = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
            billing_details: billingDetails,
        });
        
        if (error) {
            // Show error
            const errorElement = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = error.message;
            errorElement.style.display = 'flex';
            
            // Re-enable button
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
        } else {
            // Send payment method to server
            handleServerResponse(paymentMethod.id);
        }
    });
    
    async function handleServerResponse(paymentMethodId) {
        const orderId = '{{ order.id if order else "" }}';
        
        try {
            const response = await fetch('{{ url_for("payment.process_stripe_payment") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethodId,
                    order_id: orderId,
                }),
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                document.getElementById('successMessage').style.display = 'flex';
                
                // Redirect to status page
                setTimeout(function() {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                // Show error
                const errorElement = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = data.error || 'Payment failed. Please try again.';
                errorElement.style.display = 'flex';
                
                // Re-enable button
                const submitButton = document.getElementById('submit-button');
                const buttonText = document.getElementById('button-text');
                const spinner = document.getElementById('spinner');
                submitButton.disabled = false;
                buttonText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        } catch (error) {
            // Show error
            const errorElement = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = 'An error occurred. Please try again.';
            errorElement.style.display = 'flex';
            
            // Re-enable button
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
        }
    }
</script>
{% endblock %}
