{% extends "payment/base.html" %}

{% block title %}Payment Status - Barron CMS{% endblock %}

{% block content %}
<div class="payment-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb-d365">
        <a href="{{ url_for('home') }}">Home</a>
        <span class="separator">/</span>
        <a href="{{ url_for('customer.orders') }}">Orders</a>
        <span class="separator">/</span>
        <span>Payment Status</span>
    </div>

    <!-- Status Card -->
    {% if status == 'success' %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365" style="background: #4CAF50 !important; border-color: #4CAF50;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">✅</span>
                <div>
                    <h1 style="color: #4CAF50; margin: 0;">Payment Successful</h1>
                    <p style="color: #4CAF50; margin: 4px 0 0 0;">{{ message }}</p>
                </div>
            </div>
        </div>
        <div class="card-body-d365">
            <div class="alert-d365 alert-success">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>Thank you!</strong> Your payment has been processed successfully. Your order is now confirmed.
                </div>
            </div>
        </div>
    </div>

    {% elif status == 'failed' %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365" style="background: #f44336 !important; border-color: #f44336;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">❌</span>
                <div>
                    <h1 style="color: #f44336; margin: 0;">Payment Failed</h1>
                    <p style="color: #f44336; margin: 4px 0 0 0;">{{ message }}</p>
                </div>
            </div>
        </div>
        <div class="card-body-d365">
            <div class="alert-d365 alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>Payment Error:</strong> Your payment could not be processed. Please check your payment details and try again.
                </div>
            </div>
        </div>
    </div>

    {% elif status == 'pending' %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365" style="background: #FFC107 !important; border-color: #f7630c;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">⏳</span>
                <div>
                    <h1 style="color: #808080; margin: 0;">Payment Processing</h1>
                    <p style="color: #808080; margin: 4px 0 0 0;">{{ message }}</p>
                </div>
            </div>
        </div>
        <div class="card-body-d365">
            <div class="alert-d365 alert-warning">
                <span class="spinner"></span>
                <div>
                    <strong>Please wait...</strong> Your payment is being processed. This may take a few moments.
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365" style="background: #2196F3 !important; border-color: #DAA520;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">❓</span>
                <div>
                    <h1 style="color: #DAA520; margin: 0;">Unknown Status</h1>
                    <p style="color: #DAA520; margin: 4px 0 0 0;">{{ message }}</p>
                </div>
            </div>
        </div>
        <div class="card-body-d365">
            <div class="alert-d365 alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    We could not determine the status of your payment. Please contact support if you have questions.
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Order Information -->
    {% if order %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365">
            <div>
                <div class="transaction-id">Order #{{ order.order_number }}</div>
                <small>{{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
            </div>
            <span class="badge-d365 badge-{{ order.payment_status }}">
                {{ order.payment_status|upper }}
            </span>
        </div>
        <div class="transaction-details" style="border: none; border-radius: 0;">
            <div class="transaction-row">
                <span class="transaction-label">Order Status:</span>
                <span class="transaction-value">{{ order.status|upper }}</span>
            </div>

            <div class="transaction-row">
                <span class="transaction-label">Delivery Address:</span>
                <span class="transaction-value">{{ order.delivery_address|truncate(40) }}</span>
            </div>

            <div class="transaction-row">
                <span class="transaction-label">Number of Items:</span>
                <span class="transaction-value">{{ "{:,}".format(order.order_items|length) }}</span>
            </div>

            <div class="transaction-row">
                <span class="transaction-label">Subtotal:</span>
                <span class="transaction-value">${{ "{:,.2f}".format(order.subtotal) }}</span>
            </div>

            {% if order.tax_amount %}
            <div class="transaction-row">
                <span class="transaction-label">Tax:</span>
                <span class="transaction-value">${{ "{:,.2f}".format(order.tax_amount) }}</span>
            </div>
            {% endif %}

            {% if order.shipping_cost %}
            <div class="transaction-row">
                <span class="transaction-label">Shipping:</span>
                <span class="transaction-value">${{ "{:,.2f}".format(order.shipping_cost) }}</span>
            </div>
            {% endif %}

            <div class="transaction-row" style="border-top: 2px solid #DAA520; padding-top: 16px; margin-top: 12px;">
                <span class="transaction-label" style="font-size: 14px; font-weight: 600; color: #DAA520;">Total Amount:</span>
                <span class="transaction-value" style="font-size: 16px; font-weight: 600; color: #DAA520;">${{ "{:,.2f}".format(order.total_amount) }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Transaction Details -->
    {% if transaction %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365">
            <h2>Transaction Details</h2>
        </div>
        <div class="transaction-details" style="border: none; border-radius: 0;">
            <div class="transaction-row">
                <span class="transaction-label">Transaction ID:</span>
                <span class="transaction-value">{{ transaction.id }}</span>
            </div>

            {% if transaction.payment_reference %}
            <div class="transaction-row">
                <span class="transaction-label">Payment Reference:</span>
                <span class="transaction-value">{{ transaction.payment_reference }}</span>
            </div>
            {% endif %}

            <div class="transaction-row">
                <span class="transaction-label">Payment Method:</span>
                <span class="transaction-value">
                    {% if transaction.payment_method == 'stripe' %}
                    <span class="badge-d365 badge-info">STRIPE</span>
                    {% elif transaction.payment_method == 'payfast' %}
                    <span class="badge-d365 badge-warning">PAYFAST</span>
                    {% else %}
                    {{ transaction.payment_method|upper }}
                    {% endif %}
                </span>
            </div>

            <div class="transaction-row">
                <span class="transaction-label">Amount:</span>
                <span class="transaction-value">${{ "{:,.2f}".format(transaction.amount) }}</span>
            </div>

            <div class="transaction-row">
                <span class="transaction-label">Status:</span>
                <span class="transaction-value">
                    {% if transaction.status == 'completed' %}
                    <span class="badge-d365 badge-success">COMPLETED</span>
                    {% elif transaction.status == 'failed' %}
                    <span class="badge-d365 badge-error">FAILED</span>
                    {% elif transaction.status == 'pending' %}
                    <span class="badge-d365 badge-pending">PENDING</span>
                    {% else %}
                    <span class="badge-d365 badge-info">{{ transaction.status|upper }}</span>
                    {% endif %}
                </span>
            </div>

            <div class="transaction-row">
                <span class="transaction-label">Date:</span>
                <span class="transaction-value">{{ transaction.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="actions-bar">
        {% if status == 'success' %}
            <a href="{{ url_for('customer.orders') }}" class="btn-d365 btn-d365-primary">
                View My Orders
            </a>
            <a href="{{ url_for('home') }}" class="btn-d365 btn-d365-secondary">
                Return to Home
            </a>
        {% elif status == 'failed' %}
            {% if order %}
            <a href="{{ url_for('payment.select_payment_method', order_id=order.id) }}" class="btn-d365 btn-d365-primary">
                Try Again
            </a>
            {% endif %}
            <a href="{{ url_for('customer.orders') }}" class="btn-d365 btn-d365-secondary">
                View Orders
            </a>
        {% elif status == 'pending' %}
            <button type="button" class="btn-d365 btn-d365-primary" onclick="location.reload();">
                Refresh Status
            </button>
            <a href="{{ url_for('customer.orders') }}" class="btn-d365 btn-d365-secondary">
                View Orders
            </a>
        {% else %}
            <a href="{{ url_for('home') }}" class="btn-d365 btn-d365-primary">
                Return to Home
            </a>
            <a href="{{ url_for('contact') }}" class="btn-d365 btn-d365-secondary">
                Contact Support
            </a>
        {% endif %}
    </div>
</div>

<!-- Auto-refresh for pending status -->
{% if status == 'pending' %}
<script>
    setTimeout(function() {
        location.reload();
    }, 5000); // Refresh every 5 seconds
</script>
{% endif %}
{% endblock %}
