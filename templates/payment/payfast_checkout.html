{% extends "payment/base.html" %}

{% block title %}PayFast Checkout - Barron CMS{% endblock %}

{% block content %}
<div class="payment-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb-d365">
        <a href="{{ url_for('home') }}">Home</a>
        <span class="separator">/</span>
        <a href="{{ url_for('payment.select_payment_method') }}">Payment Method</a>
        <span class="separator">/</span>
        <span>PayFast Checkout</span>
    </div>

    <!-- Page Title -->
    <h1 class="page-title-d365">üè¶ PayFast Checkout</h1>

    <!-- Order Summary Card -->
    {% if order %}
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365">
            <h2>Order Summary</h2>
        </div>
        <div class="order-summary">
            <div class="order-summary-item">
                <span class="order-summary-label">Order Number:</span>
                <span class="order-summary-value">#{{ order.order_number }}</span>
            </div>
            <div class="order-summary-item">
                <span class="order-summary-label">Items:</span>
                <span class="order-summary-value">{{ "{:,}".format(order.order_items|length) }} item(s)</span>
            </div>
            <div class="order-summary-item">
                <span class="order-summary-label">Subtotal:</span>
                <span class="order-summary-value">R {{ "{:,.2f}".format(order.subtotal) }}</span>
            </div>
            {% if order.tax_amount %}
            <div class="order-summary-item">
                <span class="order-summary-label">Tax:</span>
                <span class="order-summary-value">R {{ "{:,.2f}".format(order.tax_amount) }}</span>
            </div>
            {% endif %}
            {% if order.shipping_cost %}
            <div class="order-summary-item">
                <span class="order-summary-label">Shipping:</span>
                <span class="order-summary-value">R {{ "{:,.2f}".format(order.shipping_cost) }}</span>
            </div>
            {% endif %}
            <div class="order-summary-total">
                <span>Total Amount:</span>
                <span>R {{ "{:,.2f}".format(order.total_amount) }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Messages -->
    <div id="errorMessage" class="alert-d365 alert-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <div>
            <strong>Error:</strong> <span id="errorText"></span>
        </div>
        <button class="alert-close" onclick="this.parentElement.style.display='none';">&times;</button>
    </div>

    <!-- Processing Message -->
    <div id="processingMessage" class="alert-d365 alert-info" style="display: none;">
        <span class="spinner"></span>
        <div>
            <strong>Processing...</strong> You will be redirected to PayFast to complete your payment.
        </div>
    </div>

    <!-- Payment Form Card -->
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-header-d365">
            <h2>Customer Information</h2>
            <p>Enter your details for payment processing</p>
        </div>
        <div class="card-body-d365">
            <form method="POST" id="payfast-form" class="payment-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="order_id" value="{{ order.id if order else '' }}">
                
                <!-- Customer Information -->
                <div class="form-group">
                    <label for="customer_name">Full Name</label>
                    <input type="text" id="customer_name" name="customer_name" placeholder="John Doe" value="{{ current_user.name if current_user else '' }}" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_email">Email Address</label>
                        <input type="email" id="customer_email" name="customer_email" placeholder="john@example.com" value="{{ current_user.email if current_user else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="customer_phone">Phone Number</label>
                        <input type="tel" id="customer_phone" name="customer_phone" placeholder="+27 12 345 6789">
                    </div>
                </div>

                <!-- Billing Address -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #4A4A4A;">
                    <h3 style="font-size: 14px; font-weight: 600; color: #FFFFFF; margin: 0 0 16px 0;">
                        Billing Address
                    </h3>

                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address" name="address" placeholder="123 Main Street" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City/Town</label>
                            <input type="text" id="city" name="city" placeholder="Johannesburg" required>
                        </div>
                        <div class="form-group">
                            <label for="province">Province</label>
                            <input type="text" id="province" name="province" placeholder="Gauteng" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="postal_code">Postal Code</label>
                            <input type="text" id="postal_code" name="postal_code" placeholder="2000" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" placeholder="South Africa" value="South Africa" required>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group" style="margin-top: 24px;">
                    <button type="button" class="btn-d365 btn-d365-secondary" onclick="window.history.back();">
                        Cancel
                    </button>
                    <button type="submit" class="btn-d365 btn-d365-primary" id="submit-button">
                        <span id="button-text">Proceed to PayFast - R {{ "{:,.2f}".format(order.total_amount if order else 0) }}</span>
                        <span id="spinner" class="spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PayFast Info Card -->
    <div class="stat-card" style="background: #2C2C2C; border: none; box-shadow: none;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-body-d365">
            <h3 style="font-size: 14px; font-weight: 600; color: #FFFFFF; margin: 0 0 12px 0;">
                üè¶ About PayFast
            </h3>
            <ul style="margin: 0; padding-left: 20px; color: #C0C0C0; font-size: 12px; line-height: 1.6;">
                <li>Secure South African payment gateway</li>
                <li>Supports EFT, credit cards, debit cards, and digital wallets</li>
                <li>You'll be redirected to PayFast to complete your payment</li>
                <li>Your payment information is encrypted and secure</li>
            </ul>
        </div>
    </div>

    <!-- Security Info -->
    <div class="security-info">
        <i class="fas fa-lock"></i>
        <span>üîí Secure payment powered by PayFast. Your payment information is encrypted and never stored.</span>
    </div>
</div>

<script>
    const form = document.getElementById('payfast-form');
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const processingMessage = document.getElementById('processingMessage');
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Disable button and show spinner
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';
        processingMessage.style.display = 'flex';
        
        // Submit form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        fetch('{{ url_for("payment.process_payfast_payment") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.redirect_url) {
                // Redirect to PayFast
                window.location.href = data.redirect_url;
            } else {
                // Show error
                const errorElement = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = data.error || 'Payment initialization failed. Please try again.';
                errorElement.style.display = 'flex';
                processingMessage.style.display = 'none';
                
                // Re-enable button
                submitButton.disabled = false;
                buttonText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        })
        .catch(error => {
            // Show error
            const errorElement = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = 'An error occurred. Please try again.';
            errorElement.style.display = 'flex';
            processingMessage.style.display = 'none';
            
            // Re-enable button
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
        });
    });
</script>
{% endblock %}
