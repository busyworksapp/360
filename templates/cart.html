{% extends "base.html" %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        background-color: #1C1C1C;
        min-height: 100vh;
    }

    .page-header-d365 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #DAA520;
    }

    .page-title-d365 {
        font-size: 28px;
        font-weight: 600;
        color: #FFFFFF;
        margin: 0;
    }

    .d365-card {
        background: #2C2C2C !important;
        border: 1px solid #4A4A4A;
        border-radius: 2px;
        padding: 24px;
        margin-bottom: 16px;
    }

    .card-header-d365 {
        font-size: 18px;
        font-weight: 600;
        color: #FFFFFF;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #4A4A4A;
    }

    .alert-d365 {
        padding: 12px 16px;
        border-radius: 2px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .alert-d365.alert-info {
        background-color: #2C2C2C;
        border-left: 4px solid #DAA520;
        color: #FFFFFF;
        background: #2C5F77 !important;
            color: #FFFFFF !important;
            border-left: 4px solid #2196F3 !important;
        }

    .alert-d365.alert-warning {
        background-color: #fff4ce;
        border-left: 4px solid #ffaa44;
        color: #FFFFFF;
        background: #5C4020 !important;
            color: #FFFFFF !important;
            border-left: 4px solid #FFC107 !important;
        }

    .cart-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 24px;
    }

    .cart-table {
        width: 100%;
        border-collapse: collapse;
    }

    .cart-table thead {
        background-color: #2C2C2C;
        border-bottom: 2px solid #4A4A4A;
    }

    .cart-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #FFFFFF;
        font-size: 14px;
    }

    .cart-table td {
        padding: 16px 12px;
        border-bottom: 1px solid #4A4A4A;
        vertical-align: middle;
    }

    .cart-table tr:last-child td {
        border-bottom: none;
    }

    .product-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 2px;
        border: 1px solid #4A4A4A;
    }

    .product-placeholder {
        width: 60px;
        height: 60px;
        background-color: #2C2C2C;
        border-radius: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #C0C0C0;
    }

    .product-name {
        font-weight: 600;
        color: #DAA520 !important;
        margin-bottom: 4px;
    }

    .product-unit {
        font-size: 12px;
        color: #C0C0C0;
    }

    .qty-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 120px;
    }

    .qty-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #808080;
        background: #2C2C2C !important;
        border-radius: 2px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #FFFFFF;
        transition: all 0.2s;
    }

    .qty-btn:hover {
        background-color: #2C2C2C;
        border-color: #FFFFFF;
    }

    .qty-input {
        width: 48px;
        height: 32px;
        border: 1px solid #808080;
        border-radius: 2px;
        text-align: center;
        font-weight: 600;
    }

    .btn-remove {
        padding: 6px 12px;
        background-color: #f44336;
        color: #ffffff;
        border: none;
        border-radius: 2px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .btn-remove:hover {
        background-color: #8b0a14;
    }

    .btn-d365-primary {
        padding: 12px 24px;
        background-color: #DAA520;
        color: #ffffff;
        border: none;
        border-radius: 2px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }

    .btn-d365-primary:hover {
        background-color: #B8860B;
        color: #ffffff;
    }

    .btn-d365-secondary {
        padding: 12px 24px;
        background-color: #2C2C2C !important;
        color: #FFFFFF;
        border: 1px solid #808080;
        border-radius: 2px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }

    .btn-d365-secondary:hover {
        background-color: #2C2C2C;
        border-color: #FFFFFF;
        color: #FFFFFF;
    }

    .btn-d365-success {
        padding: 12px 24px;
        background-color: #4CAF50;
        color: #ffffff;
        border: none;
        border-radius: 2px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        width: 100%;
    }

    .btn-d365-success:hover {
        background-color: #094509;
        color: #ffffff;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 14px;
        color: #FFFFFF;
    }

    .summary-row.total {
        padding-top: 12px;
        border-top: 2px solid #4A4A4A;
        font-size: 18px;
        font-weight: 600;
        margin-top: 12px;
    }

    .info-card {
        background: #2C2C2C;
        padding: 16px;
        border-radius: 2px;
        margin-top: 16px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #FFFFFF;
        margin-bottom: 8px;
    }

    .info-item:last-child {
        margin-bottom: 0;
    }

    .empty-cart {
        text-align: center;
        padding: 60px 24px;
    }

    .empty-cart i {
        font-size: 64px;
        color: #C0C0C0;
        margin-bottom: 16px;
    }

    .empty-cart h4 {
        font-size: 20px;
        font-weight: 600;
        color: #FFFFFF;
        margin-bottom: 8px;
    }

    .empty-cart p {
        color: #C0C0C0;
        margin-bottom: 24px;
    }

    @media (max-width: 992px) {
        .cart-layout {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .page-header-d365 {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="page-header-d365">
        <h1 class="page-title-d365">
            <i class="fas fa-shopping-cart"></i> Shopping Cart
        </h1>
        <a href="{{ url_for('products') }}" class="btn-d365-secondary">
            <i class="fas fa-arrow-left"></i> Continue Shopping
        </a>
    </div>

    {% if not current_user.is_authenticated %}
    <div class="alert-d365 alert-info">
        <i class="fas fa-info-circle"></i>
        <div>
            <strong>Sign in to checkout</strong> - You can browse and add items to cart. Please 
            <a href="{{ url_for('customer_login', next=url_for('checkout')) }}" style="color: #DAA520; font-weight: 600;">Login</a> or 
            <a href="{{ url_for('customer_register') }}" style="color: #DAA520; font-weight: 600;">Register</a> to complete your purchase.
        </div>
    </div>
    {% endif %}

    <div class="cart-layout">
        <!-- Cart Items -->
        <div>
            {% if (cart and cart.items) or session_cart %}
                <!-- Location-Based Pricing Info -->
                {% if pricing_context %}
                <div class="alert-d365 alert-info">
                    <i class="fas fa-globe"></i>
                    <div>
                        {% if pricing_context.is_local %}
                            <strong>Prices shown in South African Rand (ZAR)</strong>
                            {% if pricing_context.location_detected %}
                                for {{ pricing_context.country_name }}
                            {% endif %}
                        {% else %}
                            <strong>Prices shown in US Dollars (USD)</strong>
                            {% if pricing_context.location_detected %}
                                for {{ pricing_context.country_name }}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
                    <div class="card-header-d365">
                        <i class="fas fa-box"></i>
                        {% if cart %}
                            {{ "{:,}".format(cart.get_item_count()) }} Item{% if cart.get_item_count() != 1 %}s{% endif %}
                        {% else %}
                            {{ "{:,}".format(session_cart|length) }} Item{% if session_cart|length != 1 %}s{% endif %}
                        {% endif %}
                    </div>
                    
                    <table class="cart-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Unit Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if cart %}
                                {# Database cart for logged-in users #}
                                {% for item in cart.items %}
                                <tr data-item-id="{{ item.id }}">
                                    <td>
                                        <div class="product-info">
                                            {% if item.product.image_url %}
                                            <img src="{{ item.product.image_url }}" 
                                                 alt="{{ item.product.name }}"
                                                 class="product-image">
                                            {% else %}
                                            <div class="product-placeholder">
                                                <i class="fas fa-box"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="product-name">{{ item.product.name }}</div>
                                                {% if item.product.unit %}
                                                <div class="product-unit">per {{ item.product.unit }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ pricing_context.currency_symbol if pricing_context else 'R' }} {{ "{:,.2f}".format(item.price_at_add or item.product.price) }}</strong>
                                    </td>
                                    <td>
                                        <div class="qty-controls">
                                            <button class="qty-btn qty-minus" type="button">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="qty-input" 
                                                   value="{{ "{:,}".format(item.quantity) }}" min="1" max="1000">
                                            <button class="qty-btn qty-plus" type="button">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ pricing_context.currency_symbol if pricing_context else 'R' }} <span class="item-total">{{ "{:,.2f}".format(item.get_total()) }}</span></strong>
                                    </td>
                                    <td>
                                        <button class="btn-remove remove-item" title="Remove item">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                {# Session cart for guest users #}
                                {% for item in session_cart %}
                                <tr data-product-id="{{ item.product.id }}" class="session-cart-item">
                                    <td>
                                        <div class="product-info">
                                            {% if item.product.image_url %}
                                            <img src="{{ item.product.image_url }}" 
                                                 alt="{{ item.product.name }}"
                                                 class="product-image">
                                            {% else %}
                                            <div class="product-placeholder">
                                                <i class="fas fa-box"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="product-name">{{ item.product.name }}</div>
                                                {% if item.product.unit %}
                                                <div class="product-unit">per {{ item.product.unit }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ pricing_context.currency_symbol if pricing_context else 'R' }} {{ "{:,.2f}".format(item.price) }}</strong>
                                    </td>
                                    <td>
                                        <span class="session-qty">{{ "{:,}".format(item.quantity) }}</span>
                                        <div class="product-unit">Login to edit</div>
                                    </td>
                                    <td>
                                        <strong>{{ pricing_context.currency_symbol if pricing_context else 'R' }} <span class="item-total">{{ "{:,.2f}".format(item.price * item.quantity) }}</span></strong>
                                    </td>
                                    <td>
                                        <small style="color: #C0C0C0; font-size: 12px;">Login to remove</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                {% if cart %}
                <div style="margin-top: 16px;">
                    <button class="btn-d365-secondary" onclick="clearCart()">
                        <i class="fas fa-times"></i> Clear Cart
                    </button>
                </div>
                {% endif %}
            {% else %}
            <div class="d365-card empty-cart">
                <i class="fas fa-inbox"></i>
                <h4>Your cart is empty</h4>
                <p>Visit our store to add items to your cart</p>
                <a href="{{ url_for('products') }}" class="btn-d365-primary">
                    <i class="fas fa-store"></i> Visit Store
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Cart Summary -->
        <div>
            <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
                <div class="card-header-d365">
                    <i class="fas fa-receipt"></i> Order Summary
                </div>
                
                {% if (cart and cart.items) or session_cart %}
                    {% if cart %}
                        {# Logged-in user cart #}
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <strong>{{ pricing_context.currency_symbol if pricing_context else 'R' }} <span id="subtotal">{{ "{:,.2f}".format(cart.get_subtotal()) }}</span></strong>
                        </div>
                    {% else %}
                        {# Guest user session cart #}
                        {% set cart_total = namespace(value=0) %}
                        {% for item in session_cart %}
                            {% set cart_total.value = cart_total.value + (item.price * item.quantity) %}
                        {% endfor %}
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <strong>{{ pricing_context.currency_symbol if pricing_context else 'R' }} <span id="subtotal">{{ "{:,.2f}".format(cart_total.value) }}</span></strong>
                        </div>
                    {% endif %}
                    
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <strong>TBD</strong>
                    </div>
                    <div class="summary-row">
                        <span>Tax:</span>
                        <strong>TBD</strong>
                    </div>
                    
                    <div class="summary-row total">
                        <span>Total:</span>
                        {% if cart %}
                            <span>{{ pricing_context.currency_symbol if pricing_context else 'R' }} <span id="total">{{ "{:,.2f}".format(cart.get_subtotal()) }}</span></span>
                        {% else %}
                            <span>{{ pricing_context.currency_symbol if pricing_context else 'R' }} <span id="total">{{ "{:,.2f}".format(cart_total.value) }}</span></span>
                        {% endif %}
                    </div>

                    <div style="margin-top: 24px;">
                        {% if current_user.is_authenticated and current_user.__class__.__name__ == 'Customer' %}
                            <a href="{{ url_for('checkout') }}" class="btn-d365-success">
                                <i class="fas fa-credit-card"></i> Proceed to Checkout
                            </a>
                            <a href="{{ url_for('customer_orders') }}" class="btn-d365-primary" style="margin-top: 12px;">
                                <i class="fas fa-history"></i> My Orders
                            </a>
                        {% else %}
                            <a href="{{ url_for('customer_login', next=url_for('checkout')) }}" class="btn-d365-success">
                                <i class="fas fa-sign-in-alt"></i> Login to Checkout
                            </a>
                            <a href="{{ url_for('customer_register') }}" class="btn-d365-secondary" style="margin-top: 12px; width: 100%;">
                                <i class="fas fa-user-plus"></i> Create Account
                            </a>
                        {% endif %}
                    </div>
                {% else %}
                    <p style="text-align: center; color: #C0C0C0;">No items in cart</p>
                    <a href="{{ url_for('products') }}" class="btn-d365-primary" style="width: 100%;">
                        <i class="fas fa-store"></i> Visit Store
                    </a>
                {% endif %}
            </div>

            <!-- Delivery Info -->
            <div class="info-card">
                <div class="card-header-d365" style="margin-bottom: 12px;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
                    <i class="fas fa-truck"></i> Delivery Info
                </div>
                <div class="info-item">
                    <i class="fas fa-check" style="color: #4CAF50;"></i>
                    <span><strong>Free Shipping</strong> on orders over R 5,000</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock" style="color: #DAA520;"></i>
                    <span><strong>Delivery:</strong> 3-5 business days</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Quantity controls
document.querySelectorAll('.qty-plus').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = this.closest('.qty-controls').querySelector('.qty-input');
        input.value = parseInt(input.value) + 1;
        updateCartItem(this.closest('tr'));
    });
});

document.querySelectorAll('.qty-minus').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = this.closest('.qty-controls').querySelector('.qty-input');
        if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
            updateCartItem(this.closest('tr'));
        }
    });
});

document.querySelectorAll('.qty-input').forEach(input => {
    input.addEventListener('change', function() {
        updateCartItem(this.closest('tr'));
    });
});

document.querySelectorAll('.remove-item').forEach(btn => {
    btn.addEventListener('click', function() {
        removeCartItem(this.closest('tr'));
    });
});

async function updateCartItem(row) {
    const itemId = row.dataset.itemId;
    const quantity = parseInt(row.querySelector('.qty-input').value);
    
    if (quantity <= 0) {
        removeCartItem(row);
        return;
    }

    try {
        const response = await fetch(`/api/cart/update/${itemId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quantity })
        });

        const data = await response.json();
        if (data.success) {
            // Update item total
            const unitPrice = parseFloat(
                row.querySelector('td:nth-child(2)').textContent.replace('R ', '')
            );
            const total = (unitPrice * quantity).toFixed(2);
            row.querySelector('.item-total').textContent = total;
            
            // Update totals
            updateTotals();
        }
    } catch (error) {
        console.error('Error updating cart:', error);
    }
}

async function removeCartItem(row) {
    const itemId = row.dataset.itemId;

    try {
        const response = await fetch(`/api/cart/remove/${itemId}`, {
            method: 'DELETE'
        });

        const data = await response.json();
        if (data.success) {
            row.remove();
            updateTotals();
            
            // Check if cart is empty
            if (document.querySelectorAll('tbody tr').length === 0) {
                location.reload();
            }
        }
    } catch (error) {
        console.error('Error removing item:', error);
    }
}

async function clearCart() {
    if (!confirm('Are you sure you want to clear your entire cart?')) {
        return;
    }

    try {
        const response = await fetch('/api/cart/clear', {
            method: 'POST'
        });

        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Error clearing cart:', error);
    }
}

function updateTotals() {
    const rows = document.querySelectorAll('tbody tr');
    let subtotal = 0;

    rows.forEach(row => {
        const totalText = row.querySelector('.item-total').textContent;
        subtotal += parseFloat(totalText);
    });

    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('total').textContent = subtotal.toFixed(2);
}
</script>
{% endblock %}

