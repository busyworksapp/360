{% extends "customer/base.html" %}

{% block title %}Pay Invoice {{ invoice.invoice_number }} - 360Degree Supply{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        background: #1C1C1C;
        padding: 0;
    }

    .dashboard-header {
        background: #353535;
        border-bottom: 1px solid #4A4A4A;
        padding: 16px 24px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dashboard-header h1 {
        font-size: 20px;
        font-weight: 600;
        color: #FFFFFF;
        margin: 0;
    }

    .dashboard-header .subtitle {
        font-size: 12px;
        color: #C0C0C0;
        margin-top: 4px;
    }

    .info-section {
        background: #353535;
        border: 1px solid #4A4A4A;
        padding: 16px;
        margin-bottom: 20px;
    }

    .info-section h3 {
        font-size: 14px;
        font-weight: 600;
        color: #FFFFFF;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding-bottom: 8px;
        border-bottom: 1px solid #4A4A4A;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #4A4A4A;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-size: 12px;
        color: #C0C0C0;
    }

    .info-value {
        font-size: 14px;
        color: #FFFFFF;
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 12px;
        font-weight: 400;
    }

    .form-label {
        font-size: 12px;
        color: #C0C0C0;
        margin-bottom: 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control {
        background: #2C2C2C !important;
        border: 1px solid #808080 !important;
        color: #FFFFFF !important;
        padding: 10px 12px;
        font-size: 14px;
        transition: all 0.1s ease;
    }

    .form-control:focus {
        background: #353535 !important;
        border-color: #DAA520 !important;
        box-shadow: 0 0 0 2px rgba(218, 165, 32, 0.3) !important;
        outline: none !important;
    }
    
    input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #DAA520;
    }

    .grid-action-btn {
        background: #353535;
        border: 1px solid #808080;
        color: #FFFFFF;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.1s ease;
        text-decoration: none;
        display: inline-block;
    }

    .grid-action-btn:hover {
        background: #2C2C2C;
        border-color: #FFFFFF;
    }

    .grid-action-btn.btn-primary {
        background: #DAA520;
        border-color: #DAA520;
        color: white;
    }

    .grid-action-btn.btn-primary:hover {
        background: #B8860B;
    }

    .grid-action-btn.btn-success {
        background: #4CAF50;
        border-color: #4CAF50;
        color: white;
    }

    .grid-action-btn.btn-success:hover {
        background: #0b5a08;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="dashboard-header">
        <div>
            <h1>Pay Invoice</h1>
            <div class="subtitle">Complete your payment for Invoice {{ invoice.invoice_number }}</div>
        </div>
        <div>
            <a href="{{ url_for('customer_invoice_detail', invoice_id=invoice.id) }}" class="grid-action-btn">
                Back to Invoice
            </a>
        </div>
    </div>

    <div class="container-fluid" style="padding: 0 24px;">
        <div class="row">
        <!-- Invoice Summary -->
        <div class="col-md-4">
            <div class="info-section" style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; font-weight: 600; color: #DAA520; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 8px; border-bottom: 1px solid #4A4A4A;">
                    <i class="fas fa-file-invoice"></i> Invoice Summary
                </h3>
                
                <div class="info-row">
                    <span class="info-label">Invoice Number</span>
                    <span class="info-value" style="color: #DAA520;">{{ invoice.invoice_number }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Issue Date</span>
                    <span class="info-value">{{ invoice.issue_date.strftime('%d %B %Y') }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Due Date</span>
                    <span class="info-value" style="{% if invoice.is_overdue() %}color: #f44336;{% else %}color: #FFFFFF;{% endif %}">
                        {{ invoice.due_date.strftime('%d %B %Y') }}
                        {% if invoice.is_overdue() %}
                            <span class="badge badge-d365 badge-danger" style="margin-left: 8px;">Overdue</span>
                        {% endif %}
                    </span>
                </div>
                
                <div style="border-top: 2px solid #4A4A4A; margin: 16px 0;"></div>
                
                <div class="info-row">
                    <span class="info-label">Subtotal:</span>
                    <span class="info-value">R {{ "{:,.2f}".format(invoice.subtotal) }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Tax (VAT):</span>
                    <span class="info-value">R {{ "{:,.2f}".format(invoice.tax_amount) }}</span>
                </div>
                
                <div class="info-row">
                    <span class="info-label">Total:</span>
                    <span class="info-value">R {{ "{:,.2f}".format(invoice.total_amount) }}</span>
                </div>
                
                <div class="info-row" style="background-color: rgba(76, 175, 80, 0.15); padding: 8px; margin: 8px -16px; border-radius: 2px;">
                    <span class="info-label">Paid:</span>
                    <span class="info-value" style="color: #4CAF50;">R {{ "{:,.2f}".format(invoice.paid_amount) }}</span>
                </div>
                
                <div style="border-top: 3px solid #DAA520; margin: 16px 0;"></div>
                
                <div class="info-row" style="background-color: rgba(244, 67, 54, 0.15); padding: 12px; margin: 0 -16px -16px -16px; border-radius: 0 0 2px 2px;">
                    <span class="info-label" style="font-weight: 700; color: #FFFFFF;">Amount Due:</span>
                    <span class="info-value" style="font-size: 20px; color: #f44336;">
                        R{{ "{:,.2f}".format(invoice.remaining_balance()) }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Payment Form -->
        <div class="col-md-8">
            <div class="info-section" style="padding: 24px;">
                <h3 style="font-size: 14px; font-weight: 600; color: #DAA520; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 8px; border-bottom: 1px solid #4A4A4A;">
                    <i class="fas fa-lock"></i> Payment Information
                </h3>
                
                <form method="POST" enctype="multipart/form-data" id="paymentForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <div style="background: #2C5F77; border-left: 4px solid #2196F3; padding: 12px 16px; margin-bottom: 24px; border-radius: 2px;">
                        <i class="fas fa-info-circle" style="color: #2196F3;"></i>
                        <strong style="color: #FFFFFF;">Secure Payment:</strong>
                        <span style="color: #E0E0E0;">Your payment information is encrypted and secure.</span>
                    </div>

                    <!-- Payment Method Selection -->
                    <div style="margin-bottom: 24px;">
                        <label class="form-label" style="display: block; margin-bottom: 12px; color: #FFFFFF;">SELECT PAYMENT METHOD</label>
                        
                        <div class="row" style="margin: 0 -8px;">
                            <div class="col-md-6" style="padding: 0 8px;">
                                <div class="payment-option">
                                    <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" checked style="display: none;">
                                    <label class="form-check-label w-100" for="card" style="cursor: pointer;">
                                        <div class="payment-card">
                                            <i class="fas fa-credit-card fa-2x mb-2" style="color: #DAA520;"></i>
                                            <div style="color: #FFFFFF; font-weight: 600; margin-top: 8px;">Credit/Debit Card</div>
                                            <small style="color: #C0C0C0;">Visa, Mastercard, Amex</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6" style="padding: 0 8px;">
                                <div class="payment-option">
                                    <input class="form-check-input" type="radio" name="payment_method" id="eft" value="eft" style="display: none;">
                                    <label class="form-check-label w-100" for="eft" style="cursor: pointer;">
                                        <div class="payment-card">
                                            <i class="fas fa-university fa-2x mb-2" style="color: #DAA520;"></i>
                                            <div style="color: #FFFFFF; font-weight: 600; margin-top: 8px;">EFT / Bank Transfer</div>
                                            <small style="color: #C0C0C0;">Direct bank payment</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Payment Details -->
                    <div id="cardDetails" class="payment-details">
                        <h6 class="mb-3" style="color: #DAA520; font-size: 13px; font-weight: 600; text-transform: uppercase;">Card Details</h6>
                        
                        <div class="mb-3">
                            <label for="cardNumber" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="cardNumber" placeholder="1234 5,678 9,012 3456" maxlength="19" 
                                   style="background: #2C2C2C; border: 1px solid #808080; color: #FFFFFF; padding: 10px 12px; width: 100%; border-radius: 2px;">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expiryDate" class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5"
                                       style="background: #2C2C2C; border: 1px solid #808080; color: #FFFFFF; padding: 10px 12px; width: 100%; border-radius: 2px;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4"
                                       style="background: #2C2C2C; border: 1px solid #808080; color: #FFFFFF; padding: 10px 12px; width: 100%; border-radius: 2px;">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cardName" class="form-label">Cardholder Name</label>
                            <input type="text" class="form-control" id="cardName" placeholder="John Doe"
                                   style="background: #2C2C2C; border: 1px solid #808080; color: #FFFFFF; padding: 10px 12px; width: 100%; border-radius: 2px;">
                        </div>
                    </div>

                    <!-- EFT Details -->
                    <div id="eftDetails" class="payment-details" style="display: none;">
                        <div style="background: #5C4020; border-left: 4px solid #FFC107; padding: 16px; margin-bottom: 20px; border-radius: 2px;">
                            <h6 class="mb-3" style="color: #FFC107; font-size: 14px; font-weight: 600; margin: 0 0 12px 0;">
                                <i class="fas fa-info-circle"></i> Bank Transfer Instructions
                            </h6>
                            <p class="mb-2" style="color: #E0E0E0; margin-bottom: 8px;">
                                <strong style="color: #FFFFFF;">Bank Name:</strong> First National Bank
                            </p>
                            <p class="mb-2" style="color: #E0E0E0; margin-bottom: 8px;">
                                <strong style="color: #FFFFFF;">Account Name:</strong> 360 Degree Supply (Pty) Ltd
                            </p>
                            <p class="mb-2" style="color: #E0E0E0; margin-bottom: 8px;">
                                <strong style="color: #FFFFFF;">Account Number:</strong> 62,123,456,789
                            </p>
                            <p class="mb-2" style="color: #E0E0E0; margin-bottom: 8px;">
                                <strong style="color: #FFFFFF;">Branch Code:</strong> 250,655
                            </p>
                            <p class="mb-0" style="color: #E0E0E0; margin-bottom: 8px;">
                                <strong style="color: #FFFFFF;">Reference:</strong> 
                                <code style="background: #1C1C1C; color: #DAA520; padding: 4px 8px; border-radius: 2px; font-weight: 600;">{{ invoice.invoice_number }}</code>
                            </p>
                            <hr style="border-color: #808080; margin: 12px 0;">
                            <p class="mb-0" style="color: #FFC107; margin: 0;">
                                <small><i class="fas fa-exclamation-triangle"></i> Please use your invoice number as the payment reference.</small>
                            </p>
                        </div>

                        <!-- Proof of Payment Upload -->
                        <div class="mb-3">
                            <label for="proofOfPayment" class="form-label">
                                <i class="fas fa-upload"></i> UPLOAD PROOF OF PAYMENT *
                            </label>
                            <input type="file" class="form-control" id="proofOfPayment" name="proof_of_payment" 
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   style="background: #2C2C2C; border: 1px solid #808080; color: #FFFFFF; padding: 10px 12px; width: 100%; border-radius: 2px;">
                            <div style="color: #C0C0C0; font-size: 12px; margin-top: 8px;">
                                <i class="fas fa-file-pdf" style="color: #f44336;"></i> PDF or 
                                <i class="fas fa-file-image" style="color: #2196F3;"></i> Image (JPG, PNG) - Max 16MB
                            </div>
                            <div style="margin-top: 12px; padding: 12px; background: #1C4025; border-left: 3px solid #4CAF50; border-radius: 2px;">
                                <small style="color: #A8E6A8;">
                                    <i class="fas fa-magic"></i> <strong>Intelligent Processing:</strong> 
                                    Our system will automatically read and verify your payment details from the uploaded document
                                </small>
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="mb-3" style="display: none;">
                            <div style="background: #2C2C2C; border: 1px solid #4A4A4A; padding: 12px; border-radius: 2px;">
                                <div style="display: flex; align-items: center;">
                                    <div style="margin-right: 16px;">
                                        <i class="fas fa-file-alt fa-2x" style="color: #808080;"></i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <h6 id="fileName" style="margin: 0 0 4px 0; color: #FFFFFF; font-size: 14px;"></h6>
                                        <small id="fileSize" style="color: #C0C0C0;"></small>
                                    </div>
                                    <button type="button" onclick="clearFile()" 
                                            style="background: transparent; border: 1px solid #f44336; color: #f44336; padding: 4px 12px; border-radius: 2px; cursor: pointer;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #2C2C2C; border: 1px solid #808080; padding: 16px; margin-top: 24px; border-radius: 2px;">
                        <div style="display: flex; align-items: start;">
                            <input type="checkbox" id="termsAccept" required style="margin-right: 12px; margin-top: 4px;">
                            <label for="termsAccept" style="color: #E0E0E0; font-size: 14px; margin: 0;">
                                I agree to the <a href="#" style="color: #DAA520;">terms and conditions</a> and authorize this payment
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 24px;">
                        <button type="submit" style="background: #DAA520 !important; border: none; color: #000000 !important; padding: 14px 40px; font-size: 18px; font-weight: 700 !important; width: 100%; border-radius: 2px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 12px;"
                                onmouseover="this.style.background='#FFC107'"
                                onmouseout="this.style.background='#DAA520'">
                            <i class="fas fa-lock"></i> Pay R{{ "{:,.2f}".format(invoice.remaining_balance()) }}
                        </button>
                        <a href="{{ url_for('customer_invoice_detail', invoice_id=invoice.id) }}" 
                           class="grid-action-btn" style="display: block; text-align: center; padding: 12px; width: 100%;">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>

            <div style="text-align: center; margin-top: 24px;">
                <p style="color: #C0C0C0; margin: 0;">
                    <i class="fas fa-shield-alt"></i> Secured by 256-bit SSL encryption
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .payment-option {
        height: 100%;
    }
    
    .payment-card {
        border: 2px solid #4A4A4A;
        border-radius: 2px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        height: 100%;
        background: #2C2C2C;
    }
    
    .payment-card:hover {
        border-color: #DAA520;
        background-color: #353535;
        box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
    }
    
    .form-check-input:checked ~ .form-check-label .payment-card {
        border-color: #DAA520;
        border-width: 3px;
        background-color: #3A3520;
        box-shadow: 0 0 12px rgba(218, 165, 32, 0.4);
    }
</style>

<script>
    // Toggle payment details based on selected method
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('cardDetails').style.display = 
                this.value === 'card' ? 'block' : 'none';
            document.getElementById('eftDetails').style.display = 
                this.value === 'eft' ? 'block' : 'none';
            
            // Update file input required attribute
            const fileInput = document.getElementById('proofOfPayment');
            if (this.value === 'eft') {
                fileInput.setAttribute('required', 'required');
            } else {
                fileInput.removeAttribute('required');
            }
        });
    });
    
    // File upload preview and validation
    const fileInput = document.getElementById('proofOfPayment');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                // Validate file size (16MB max)
                const maxSize = 16 * 1,024 * 1,024;
                if (file.size > maxSize) {
                    alert('File size exceeds 16MB. Please upload a smaller file.');
                    this.value = '';
                    return;
                }

                // Validate file type
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Invalid file type. Please upload PDF, JPG, or PNG only.');
                    this.value = '';
                    return;
                }

                // Show preview
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('filePreview').style.display = 'block';
            }
        });
    }
    
    // Clear file function
    function clearFile() {
        document.getElementById('proofOfPayment').value = '';
        document.getElementById('filePreview').style.display = 'none';
    }
    
    // Format file size helper
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1,024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Format card number with spaces
    document.getElementById('cardNumber')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    });
    
    // Format expiry date
    document.getElementById('expiryDate')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            e.target.value = value.slice(0, 2) + '/' + value.slice(2, 4);
        } else {
            e.target.value = value;
        }
    });
    
    // Form submission validation
    document.getElementById('paymentForm')?.addEventListener('submit', function(e) {
        const termsAccept = document.getElementById('termsAccept');
        if (!termsAccept.checked) {
            e.preventDefault();
            alert('Please accept the terms and conditions to proceed with payment.');
            return false;
        }

        // Extra validation for EFT payment
        const eftRadio = document.getElementById('eft');
        if (eftRadio && eftRadio.checked) {
            const fileInput = document.getElementById('proofOfPayment');
            if (!fileInput.files || !fileInput.files[0]) {
                e.preventDefault();
                alert('Please upload proof of payment for EFT/Bank Transfer.');
                return false;
            }
        }

        // Show loading state
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        }
    });
</script>
{% endblock %}
