{% extends "base.html" %}
{% block title %}Blocked IPs - Master Admin{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1><i class="fas fa-ban"></i> IP Blocking Management</h1>
    
    <button class="btn btn-danger mb-3" data-bs-toggle="modal" data-bs-target="#blockIPModal">
        <i class="fas fa-plus"></i> Block New IP
    </button>
    
    <div class="card bg-dark mb-3">
        <div class="card-body">
            <h5>Currently Blocked: {{ blocked_ips.total }} IPs</h5>
        </div>
    </div>
    
    <table class="table table-dark">
        <thead>
            <tr>
                <th>IP Address</th>
                <th>Reason</th>
                <th>Type</th>
                <th>Blocked At</th>
                <th>Expires</th>
                <th>Attempts</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for blocked in blocked_ips.items %}
            <tr>
                <td><code>{{ blocked.ip_address }}</code></td>
                <td>{{ blocked.reason }}</td>
                <td>
                    <span class="badge bg-{{ 'danger' if blocked.is_permanent else 'warning' }}">
                        {{ 'Permanent' if blocked.is_permanent else 'Temporary' }}
                    </span>
                </td>
                <td>{{ blocked.blocked_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ blocked.expires_at.strftime('%Y-%m-%d %H:%M') if blocked.expires_at else 'Never' }}</td>
                <td><span class="badge bg-info">{{ blocked.block_count }}</span></td>
                <td>
                    <form method="POST" action="{{ url_for('master_admin.unblock_ip', block_id=blocked.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Unblock this IP?')">
                            <i class="fas fa-unlock"></i> Unblock
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <nav>
        <ul class="pagination">
            {% if blocked_ips.has_prev %}<li class="page-item"><a class="page-link" href="?page={{ blocked_ips.prev_num }}">Previous</a></li>{% endif %}
            {% if blocked_ips.has_next %}<li class="page-item"><a class="page-link" href="?page={{ blocked_ips.next_num }}">Next</a></li>{% endif %}
        </ul>
    </nav>
</div>

<!-- Block IP Modal -->
<div class="modal fade" id="blockIPModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Block IP Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('master_admin.block_ip') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">IP Address</label>
                        <input type="text" name="ip_address" class="form-control" placeholder="192.168.1.1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea name="reason" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" name="is_permanent" class="form-check-input" id="isPermanent">
                        <label class="form-check-label" for="isPermanent">Permanent Block</label>
                    </div>
                    <div class="mb-3" id="durationField">
                        <label class="form-label">Duration (hours)</label>
                        <input type="number" name="duration_hours" class="form-control" value="24" min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Block IP</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('isPermanent').addEventListener('change', function() {
    document.getElementById('durationField').style.display = this.checked ? 'none' : 'block';
});
</script>
{% endblock %}
