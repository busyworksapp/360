{% extends "admin/base.html" %}

{% block title %}Invoices - Admin{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Breadcrumb & Page Title -->
    <div style="margin-bottom: 16px;">
        <div class="breadcrumb-d365">
            <a href="{{ url_for('admin_dashboard') }}">Home</a>
            <span class="separator">/</span>
            <span>Invoices</span>
        </div>
        <h1 style="font-size: 20px; font-weight: 600; margin: 4px 0 0 0; color: #FFFFFF !important;">Invoices</h1>
    </div>

    <!-- Summary Cards - Compact D365 Style -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
        <div style="background: #353535; border: 1px solid #4A4A4A; border-radius: 2px; padding: 12px;">
            <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 4px;">TOTAL INVOICES</div>
            <div style="font-size: 24px; font-weight: 600; color: #FFFFFF !important;">{{ "{:,}".format(total_invoices) }}</div>
        </div>
        <div style="background: #353535; border: 1px solid #4A4A4A; border-radius: 2px; padding: 12px;">
            <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 4px;">TOTAL AMOUNT</div>
            <div style="font-size: 24px; font-weight: 600; color: #FFFFFF !important;">R{{ "%.0f"|format(total_amount) }}</div>
        </div>
        <div style="background: #353535; border: 1px solid #4A4A4A; border-radius: 2px; padding: 12px;">
            <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 4px;">AMOUNT PAID</div>
            <div style="font-size: 24px; font-weight: 600; color: #4CAF50;">R{{ "%.0f"|format(total_paid) }}</div>
        </div>
        <div style="background: #353535; border: 1px solid #4A4A4A; border-radius: 2px; padding: 12px;">
            <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 4px;">OUTSTANDING</div>
            <div style="font-size: 24px; font-weight: 600; color: #f44336;">R{{ "%.0f"|format(outstanding) }}</div>
        </div>
    </div>

    <!-- Command Bar -->
    <div class="command-bar-d365">
        <div class="command-bar-left">
            <a href="{{ url_for('admin_invoice_create') }}" class="btn-d365-primary" style="font-size: 12px; padding: 6px 12px;">
                <i class="fas fa-plus"></i>
                <span>New Invoice</span>
            </a>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" disabled>
                <i class="fas fa-eye"></i>
                <span>View</span>
            </button>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" disabled>
                <i class="fas fa-edit"></i>
                <span>Edit</span>
            </button>
            <div style="width: 1px; height: 24px; background: #4A4A4A; margin: 0 4px;"></div>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="location.reload()">
                <i class="fas fa-sync"></i>
                <span>Refresh</span>
            </button>
        </div>
        <div class="command-bar-right">
            <div class="search-box-d365">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Filter" id="filterInput" />
            </div>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-body-d365" style="padding: 0;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            {% if invoices %}
                <table class="table-d365">
                    <thead>
                        <tr>
                            <th class="row-checkbox">
                                <input type="checkbox" id="selectAll" />
                            </th>
                            <th class="sortable" style="width: 140px;">
                                <div class="column-header">
                                    <span class="column-title">Invoice #</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable">
                                <div class="column-header">
                                    <span class="column-title">Customer</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px;">
                                <div class="column-header">
                                    <span class="column-title">Issue date</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px;">
                                <div class="column-header">
                                    <span class="column-title">Due date</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px; text-align: right;">
                                <div class="column-header">
                                    <span class="column-title">Amount</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px; text-align: right;">
                                <div class="column-header">
                                    <span class="column-title">Paid</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px; text-align: right;">
                                <div class="column-header">
                                    <span class="column-title">Balance</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 100px;">
                                <div class="column-header">
                                    <span class="column-title">Status</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                    </span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                            <tr onclick="selectRow(this, event)" style="cursor: pointer;">
                                <td class="row-checkbox">
                                    <input type="checkbox" class="row-select" onclick="event.stopPropagation();" />
                                </td>
                                <td>
                                    <a href="{{ url_for('admin_invoice_detail', invoice_id=invoice.id) }}">{{ invoice.invoice_number }}</a>
                                </td>
                                <td>
                                    <div style="font-weight: 600;">{{ invoice.customer.get_full_name() }}</div>
                                    <div style="font-size: 11px; color: #C0C0C0;">{{ invoice.customer.email }}</div>
                                </td>
                                <td style="font-size: 11px;">{{ invoice.issue_date.strftime('%d %b %Y') }}</td>
                                <td style="font-size: 11px; {% if invoice.is_overdue() %}color: #f44336; font-weight: 600;{% endif %}">
                                    {{ invoice.due_date.strftime('%d %b %Y') }}
                                </td>
                                <td style="text-align: right; font-weight: 600;">R {{ "{:,.2f}".format(invoice.total_amount) }}</td>
                                <td style="text-align: right; color: #4CAF50; font-weight: 600;">R {{ "{:,.2f}".format(invoice.paid_amount) }}</td>
                                <td style="text-align: right; {% if invoice.remaining_balance() > 0 %}color: #f44336;{% else %}color: #4CAF50;{% endif %} font-weight: 600;">
                                    R{{ "{:,.2f}".format(invoice.remaining_balance()) }}
                                </td>
                                <td>
                                    {% if invoice.status == 'paid' %}
                                        <span class="badge-d365 success" style="font-size: 11px;">Paid</span>
                                    {% elif invoice.status == 'partial' %}
                                        <span class="badge-d365 warning" style="font-size: 11px;">Partial</span>
                                    {% elif invoice.is_overdue() %}
                                        <span class="badge-d365 danger" style="font-size: 11px;">Overdue</span>
                                    {% elif invoice.status == 'sent' %}
                                        <span class="badge-d365 info" style="font-size: 11px;">Sent</span>
                                    {% else %}
                                        <span class="badge-d365 info" style="font-size: 11px;">{{ invoice.status|capitalize }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div style="text-align: center; padding: 48px; color: #808080;">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 36px; margin-bottom: 12px; display: block; opacity: 0.3;"></i>
                    <p style="margin: 0 0 12px 0; font-size: 13px;">No invoices found.</p>
                    <a href="{{ url_for('admin_invoice_create') }}" class="btn-d365-primary" style="font-size: 12px; padding: 6px 12px;">
                        <i class="fas fa-plus"></i> Create Invoice
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer Info -->
    <div style="margin-top: 12px; font-size: 12px; color: #C0C0C0;">
        <span>Total records: {{ "{:,}".format(invoices|length) }}</span>
    </div>
</div>

<style>
    .dashboard-container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        background: #1C1C1C !important;
    }

    .content {
        background: #1C1C1C !important;
        padding: 16px 24px !important;
    }
</style>

<script>
// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add change event to all checkboxes
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
            updateCommandBar();
        });
    });
    
    // Select All Checkbox
    document.getElementById('selectAll')?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(cb => {
            cb.checked = this.checked;
            const row = cb.closest('tr');
            if (this.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
        updateCommandBar();
    });
    
    // Initial update
    updateCommandBar();
});

// Row Selection
function selectRow(row, event) {
    if (event.target.type === 'checkbox' || event.target.tagName === 'A') return;
    const checkbox = row.querySelector('.row-select');
    checkbox.checked = !checkbox.checked;
    if (checkbox.checked) {
        row.classList.add('selected');
    } else {
        row.classList.remove('selected');
    }
    updateCommandBar();
}

// Update Command Bar based on selection
function updateCommandBar() {
    const selectedCount = document.querySelectorAll('.row-select:checked').length;
    const viewBtn = document.querySelector('.command-bar-left button:nth-child(2)');
    const editBtn = document.querySelector('.command-bar-left button:nth-child(3)');
    
    if (selectedCount > 0) {
        viewBtn.disabled = selectedCount !== 1;
        editBtn.disabled = selectedCount !== 1;
    } else {
        viewBtn.disabled = true;
        editBtn.disabled = true;
    }
}

// Filter functionality
document.getElementById('filterInput')?.addEventListener('input', function(e) {
    const filter = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.table-d365 tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});
</script>
{% endblock %}
