{% extends "admin/base.html" %}

{% block title %}Order #{{ order.id }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>
            <i class="fas fa-shopping-bag"></i> Order #{{ order.id }}
        </h2>
        <p class="text-muted">Placed on {{ order.created_at.strftime('%d %B %Y at %H:%M') }}</p>
    </div>
    <div class="col-md-4 text-end">
        <span class="badge" style="font-size: 0.95rem; padding: 0.5rem 1rem;">
            {% if order.status == 'pending' %}
                <span class="badge bg-warning"><i class="fas fa-hourglass-half"></i> Pending</span>
            {% elif order.status == 'processing' %}
                <span class="badge bg-info"><i class="fas fa-cogs"></i> Processing</span>
            {% elif order.status == 'shipped' %}
                <span class="badge bg-primary"><i class="fas fa-truck"></i> Shipped</span>
            {% elif order.status == 'delivered' %}
                <span class="badge bg-success"><i class="fas fa-check-circle"></i> Delivered</span>
            {% elif order.status == 'cancelled' %}
                <span class="badge bg-danger"><i class="fas fa-times-circle"></i> Cancelled</span>
            {% else %}
                <span class="badge bg-secondary">{{ order.status|capitalize }}</span>
            {% endif %}
        </span>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <!-- Order Details -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header" style="background: #353535 !important; color: #FFFFFF !important; border-bottom: 1px solid #4A4A4A !important;" style="background: #353535 !important; color: #FFFFFF !important;">
                <h5 class="mb-0"><i class="fas fa-user"></i> Customer Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Name</h6>
                        <p><strong>{{ order.customer.get_full_name() }}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Email</h6>
                        <p><a href="mailto:{{ order.customer.email }}">{{ order.customer.email }}</a></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Phone</h6>
                        <p>{{ order.customer.phone or 'N/A' }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Company</h6>
                        <p>{{ order.customer.company or 'N/A' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4">
            <div class="card-header" style="background: #353535 !important; color: #FFFFFF !important; border-bottom: 1px solid #4A4A4A !important;" style="background: #353535 !important; color: #FFFFFF !important;">
                <h5 class="mb-0"><i class="fas fa-list"></i> Order Items</h5>
            </div>
            <div class="card-body">
                {% if order.items %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items %}
                                    <tr>
                                        <td>
                                            <strong>{{ item.product.name if item.product else 'Product (Deleted)' }}</strong>
                                            {% if item.product %}
                                                <br><small class="text-muted">SKU: {{ item.product.sku or 'N/A' }}</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ "{:,}".format(item.quantity) }}</td>
                                        <td>R {{ "{:,.2f}".format(item.price_at_purchase) }}</td>
                                        <td><strong>R {{ "{:,.2f}".format(item.quantity * item.price_at_purchase) }}</strong></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No items in this order.</p>
                {% endif %}
            </div>
        </div>

        <!-- Update Status Form -->
        <div class="card">
            <div class="card-header" style="background: #353535 !important; color: #FFFFFF !important; border-bottom: 1px solid #4A4A4A !important;" style="background: #353535 !important; color: #FFFFFF !important;">
                <h5 class="mb-0"><i class="fas fa-sync"></i> Update Status</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">Order Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                                <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                                <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                                <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="notes" class="form-label">Notes</label>
                            <input type="text" class="form-control" id="notes" name="notes" placeholder="Order notes...">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Order
                    </button>
                    <a href="{{ url_for('admin_orders') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Orders
                    </a>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            <div class="card-header" style="background: #353535 !important; color: #FFFFFF !important; border-bottom: 1px solid #4A4A4A !important;" style="background: #353535 !important; color: #FFFFFF !important;">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Order Summary</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td>Subtotal:</td>
                        <td class="text-end"><strong>R {{ "{:,.2f}".format(order.subtotal or 0) }}</strong></td>
                    </tr>
                    <tr>
                        <td>Shipping:</td>
                        <td class="text-end"><strong>R {{ "{:,.2f}".format(order.shipping_cost or 0) }}</strong></td>
                    </tr>
                    <tr>
                        <td>Tax:</td>
                        <td class="text-end"><strong>R {{ "{:,.2f}".format(order.tax_amount or 0) }}</strong></td>
                    </tr>
                    <tr style="border-top: 2px solid #dee2e6;">
                        <td><strong>Total:</strong></td>
                        <td class="text-end"><strong style="font-size: 1.2rem; color: #DAA520;">R {{ "{:,.2f}".format(order.total_amount) }}</strong></td>
                    </tr>
                </table>

                <hr>

                <h6 class="mb-3">Shipping Address</h6>
                <address style="font-size: 0.9rem;">
                    {{ order.customer.get_full_name() }}<br>
                    {{ order.customer.address or 'N/A' }}<br>
                    {{ order.customer.city or '' }}, {{ order.customer.postal_code or '' }}<br>
                    {{ order.customer.country or 'South Africa' }}
                </address>

                {% if order.transaction %}
                    <hr>
                    <h6 class="mb-3">Payment Info</h6>
                    <p class="small">
                        <strong>Status:</strong>
                        {% if order.transaction.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                        {% elif order.transaction.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                        {% else %}
                            <span class="badge bg-danger">{{ order.transaction.status }}</span>
                        {% endif %}
                    </p>
                    <p class="small">
                        <strong>Method:</strong> {{ order.transaction.payment_method|capitalize }}<br>
                        <strong>Reference:</strong> <code>{{ order.transaction.payment_reference[:16] }}...</code>
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
