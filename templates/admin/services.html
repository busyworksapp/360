{% extends "admin/base.html" %}

{% block title %}Services Management - Admin{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Breadcrumb & Page Title -->
    <div style="margin-bottom: 16px;">
        <div class="breadcrumb-d365">
            <a href="{{ url_for('admin_dashboard') }}">Home</a>
            <span class="separator">/</span>
            <span>Services</span>
        </div>
        <h1 style="font-size: 20px; font-weight: 600; margin: 4px 0 0 0; color: #323130;">Services</h1>
    </div>

    <!-- Command Bar -->
    <div class="command-bar-d365">
        <div class="command-bar-left">
            <a href="{{ url_for('admin_service_add') }}" class="btn-d365-primary" style="font-size: 12px; padding: 6px 12px;">
                <i class="fas fa-plus"></i>
                <span>New</span>
            </a>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" disabled>
                <i class="fas fa-edit"></i>
                <span>Edit</span>
            </button>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" disabled>
                <i class="fas fa-trash"></i>
                <span>Delete</span>
            </button>
            <div style="width: 1px; height: 24px; background: #edebe9; margin: 0 4px;"></div>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="location.reload()">
                <i class="fas fa-sync"></i>
                <span>Refresh</span>
            </button>
        </div>
        <div class="command-bar-right">
            <div class="search-box-d365">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Filter" id="filterInput" />
            </div>
        </div>
    </div>

    <!-- Services Table -->
    <div class="d365-card">
        <div class="card-body-d365" style="padding: 0;">
            <table class="table-d365">
                <thead>
                    <tr>
                        <th class="row-checkbox">
                            <input type="checkbox" id="selectAll" />
                        </th>
                        <th class="sortable">
                            <div class="column-header">
                                <span class="column-title">Service title</span>
                                <span class="column-icons">
                                    <i class="fas fa-filter filter-icon"></i>
                                    <i class="fas fa-sort sort-icon"></i>
                                </span>
                            </div>
                        </th>
                        <th class="sortable">
                            <div class="column-header">
                                <span class="column-title">Description</span>
                                <span class="column-icons">
                                    <i class="fas fa-filter filter-icon"></i>
                                </span>
                            </div>
                        </th>
                        <th class="sortable" style="width: 80px;">
                            <div class="column-header">
                                <span class="column-title">Icon</span>
                                <span class="column-icons">
                                    <i class="fas fa-filter filter-icon"></i>
                                </span>
                            </div>
                        </th>
                        <th class="sortable" style="width: 100px; text-align: center;">
                            <div class="column-header">
                                <span class="column-title">Display order</span>
                                <span class="column-icons">
                                    <i class="fas fa-sort sort-icon"></i>
                                </span>
                            </div>
                        </th>
                        <th class="sortable" style="width: 100px;">
                            <div class="column-header">
                                <span class="column-title">Status</span>
                                <span class="column-icons">
                                    <i class="fas fa-filter filter-icon"></i>
                                </span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for service in services %}
                    <tr onclick="selectRow(this, event)" style="cursor: pointer;">
                        <td class="row-checkbox">
                            <input type="checkbox" class="row-select" onclick="event.stopPropagation();" />
                        </td>
                        <td>
                            <a href="{{ url_for('admin_service_edit', id=service.id) }}">{{ service.title }}</a>
                        </td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ service.description[:80] }}{% if service.description|length > 80 %}...{% endif %}
                        </td>
                        <td style="text-align: center;">
                            <i class="fas {{ service.icon }}" style="font-size: 16px; color: #0078d4;"></i>
                        </td>
                        <td style="text-align: center;">{{ service.order_position }}</td>
                        <td>
                            {% if service.is_active %}
                                <span class="badge-d365 success" style="font-size: 11px;">Active</span>
                            {% else %}
                                <span class="badge-d365 warning" style="font-size: 11px;">Inactive</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 48px; color: #a19f9d;">
                            <i class="fas fa-cogs" style="font-size: 36px; margin-bottom: 12px; display: block; opacity: 0.3;"></i>
                            <p style="margin: 0; font-size: 13px;">No services found. Click "New" to add your first service.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer Info -->
    <div style="margin-top: 12px; font-size: 12px; color: #605e5c;">
        <span>Total records: {{ services|length }}</span>
    </div>
</div>

<style>
    .dashboard-container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        background: #faf9f8 !important;
    }

    .content {
        background: #faf9f8 !important;
        padding: 16px 24px !important;
    }
</style>

<script>
// Select All Checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateCommandBar();
});

// Row Selection
function selectRow(row, event) {
    // Don't interfere with checkbox clicks or link clicks
    if (event.target.type === 'checkbox' || event.target.tagName === 'A') return;
    
    // Check if clicked element is inside a link
    if (event.target.closest('a')) return;
    
    const checkbox = row.querySelector('.row-select');
    checkbox.checked = !checkbox.checked;
    updateCommandBar();
}

// Update Command Bar based on selection
function updateCommandBar() {
    const selectedCount = document.querySelectorAll('.row-select:checked').length;
    const editBtn = document.querySelector('.command-bar-left button:nth-child(2)');
    const deleteBtn = document.querySelector('.command-bar-left button:nth-child(3)');
    
    if (selectedCount > 0) {
        editBtn.disabled = selectedCount !== 1;
        deleteBtn.disabled = false;
        
        // Make edit button functional when one item is selected
        if (selectedCount === 1) {
            editBtn.onclick = function() {
                const selectedCheckbox = document.querySelector('.row-select:checked');
                const row = selectedCheckbox.closest('tr');
                const link = row.querySelector('a[href*="edit"]');
                if (link) {
                    window.location.href = link.href;
                }
            };
        }
    } else {
        editBtn.disabled = true;
        deleteBtn.disabled = true;
        editBtn.onclick = null;
    }
}

// Filter functionality
document.getElementById('filterInput')?.addEventListener('input', function(e) {
    const filter = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.table-d365 tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});

// Add checkbox change listeners
document.querySelectorAll('.row-select').forEach(checkbox => {
    checkbox.addEventListener('change', updateCommandBar);
});

// Column Filtering
document.querySelectorAll('.filter-icon').forEach(icon => {
    icon.addEventListener('click', function(e) {
        e.stopPropagation();
        const th = this.closest('th');
        const columnIndex = Array.from(th.parentElement.children).indexOf(th);
        
        // Remove any existing filter dropdowns
        document.querySelectorAll('.filter-dropdown').forEach(d => d.remove());
        
        // Get unique values from this column
        const values = new Set();
        document.querySelectorAll('.table-d365 tbody tr').forEach(row => {
            const cell = row.children[columnIndex];
            if (cell) {
                const text = cell.textContent.trim();
                if (text) values.add(text);
            }
        });
        
        // Create filter dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'filter-dropdown';
        dropdown.style.cssText = `
            position: absolute;
            background: white;
            border: 1px solid #8a8886;
            border-radius: 2px;
            box-shadow: 0 6.4px 14.4px 0 rgba(0,0,0,.132);
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            padding: 8px 0;
        `;
        
        // Add "All" option
        const allOption = document.createElement('div');
        allOption.style.cssText = `
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            color: #323130;
        `;
        allOption.textContent = '(Select All)';
        allOption.addEventListener('mouseenter', function() {
            this.style.background = '#f3f2f1';
        });
        allOption.addEventListener('mouseleave', function() {
            this.style.background = 'white';
        });
        allOption.addEventListener('click', function() {
            document.querySelectorAll('.table-d365 tbody tr').forEach(row => {
                row.style.display = '';
            });
            dropdown.remove();
        });
        dropdown.appendChild(allOption);
        
        // Add divider
        const divider = document.createElement('div');
        divider.style.cssText = 'height: 1px; background: #edebe9; margin: 4px 0;';
        dropdown.appendChild(divider);
        
        // Add value options
        Array.from(values).sort().forEach(value => {
            const option = document.createElement('div');
            option.style.cssText = `
                padding: 8px 16px;
                cursor: pointer;
                font-size: 12px;
                color: #323130;
            `;
            option.textContent = value;
            option.addEventListener('mouseenter', function() {
                this.style.background = '#f3f2f1';
            });
            option.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
            option.addEventListener('click', function() {
                // Filter rows
                document.querySelectorAll('.table-d365 tbody tr').forEach(row => {
                    const cell = row.children[columnIndex];
                    if (cell) {
                        const cellText = cell.textContent.trim();
                        row.style.display = cellText === value ? '' : 'none';
                    }
                });
                dropdown.remove();
            });
            dropdown.appendChild(option);
        });
        
        // Position dropdown
        const rect = icon.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        document.body.appendChild(dropdown);
        
        // Close dropdown when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown() {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            });
        }, 0);
    });
});

// Column Sorting
document.querySelectorAll('.sort-icon').forEach(icon => {
    icon.addEventListener('click', function(e) {
        e.stopPropagation();
        const th = this.closest('th');
        const columnIndex = Array.from(th.parentElement.children).indexOf(th);
        const tbody = document.querySelector('.table-d365 tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Determine sort direction
        const currentDirection = th.dataset.sortDirection || 'asc';
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        th.dataset.sortDirection = newDirection;
        
        // Update icon
        this.className = newDirection === 'asc' ? 'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';
        
        // Sort rows
        rows.sort((a, b) => {
            const aText = a.children[columnIndex]?.textContent.trim() || '';
            const bText = b.children[columnIndex]?.textContent.trim() || '';
            
            // Try numeric comparison
            const aNum = parseFloat(aText);
            const bNum = parseFloat(bText);
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
            }
            
            // String comparison
            return newDirection === 'asc' 
                ? aText.localeCompare(bText)
                : bText.localeCompare(aText);
        });
        
        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    });
});
</script>
{% endblock %}
