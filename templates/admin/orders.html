{% extends "admin/base.html" %}

{% block title %}Orders Management - Admin{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Breadcrumb & Page Title -->
    <div style="margin-bottom: 16px;">
        <div class="breadcrumb-d365">
            <a href="{{ url_for('admin_dashboard') }}">Home</a>
            <span class="separator">/</span>
            <span>Orders</span>
        </div>
        <h1 style="font-size: 20px; font-weight: 600; margin: 4px 0 0 0; color: #FFFFFF !important;">Orders</h1>
    </div>

    <!-- Command Bar with Status Filters -->
    <div class="command-bar-d365">
        <div class="command-bar-left">
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" disabled>
                <i class="fas fa-eye"></i>
                <span>View</span>
            </button>
            <button class="btn-d365-secondary" style="font-size: 12px; padding: 6px 12px;" disabled>
                <i class="fas fa-edit"></i>
                <span>Update Status</span>
            </button>
            <div style="width: 1px; height: 24px; background: #4A4A4A; margin: 0 4px;"></div>
            <a href="?status=all" class="{% if current_status == 'all' %}btn-d365-primary{% else %}btn-d365-secondary{% endif %}" style="font-size: 12px; padding: 6px 12px;">
                All ({{ "{:,}".format(orders.total) }})
            </a>
            <a href="?status=pending" class="{% if current_status == 'pending' %}btn-d365-primary{% else %}btn-d365-secondary{% endif %}" style="font-size: 12px; padding: 6px 12px;">
                Pending
            </a>
            <a href="?status=processing" class="{% if current_status == 'processing' %}btn-d365-primary{% else %}btn-d365-secondary{% endif %}" style="font-size: 12px; padding: 6px 12px;">
                Processing
            </a>
            <a href="?status=delivered" class="{% if current_status == 'delivered' %}btn-d365-primary{% else %}btn-d365-secondary{% endif %}" style="font-size: 12px; padding: 6px 12px;">
                Delivered
            </a>
        </div>
        <div class="command-bar-right">
            <div class="search-box-d365">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Filter" id="filterInput" />
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="stat-card" style="background: #2C2C2C !important; border: 1px solid #4A4A4A !important;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
        <div class="card-body-d365" style="padding: 0;; border: 1px solid #4A4A4A !important; border: 1px solid #4A4A4A !important">
            {% if orders.items %}
                <table class="table-d365">
                    <thead>
                        <tr>
                            <th class="row-checkbox">
                                <input type="checkbox" id="selectAll" />
                            </th>
                            <th class="sortable">
                                <div class="column-header">
                                    <span class="column-title">Order number</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable">
                                <div class="column-header">
                                    <span class="column-title">Customer</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 130px;">
                                <div class="column-header">
                                    <span class="column-title">Order date</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 80px; text-align: center;">
                                <div class="column-header">
                                    <span class="column-title">Items</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 120px; text-align: right;">
                                <div class="column-header">
                                    <span class="column-title">Total amount</span>
                                    <span class="column-icons">
                                        <i class="fas fa-sort sort-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px;">
                                <div class="column-header">
                                    <span class="column-title">Status</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable" style="width: 110px;">
                                <div class="column-header">
                                    <span class="column-title">Payment</span>
                                    <span class="column-icons">
                                        <i class="fas fa-filter filter-icon"></i>
                                    </span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders.items %}
                            <tr onclick="selectRow(this, event)" style="cursor: pointer;">
                                <td class="row-checkbox">
                                    <input type="checkbox" class="row-select" onclick="event.stopPropagation();" />
                                </td>
                                <td>
                                    <a href="/admin/orders/{{ order.id }}">{{ order.order_number }}</a>
                                </td>
                                <td>
                                    <div style="font-weight: 600;">{{ order.customer.first_name }} {{ order.customer.last_name }}</div>
                                    <div style="font-size: 11px; color: #C0C0C0;">{{ order.customer.email }}</div>
                                </td>
                                <td style="font-size: 11px;">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td style="text-align: center;">{{ "{:,}".format(order.get_item_count()) }}</td>
                                <td style="text-align: right; font-weight: 600;">R {{ "{:,.2f}".format(order.total_amount) }}</td>
                                <td>
                                    {% if order.status == 'pending' %}
                                        <span class="badge-d365 warning" style="font-size: 11px;">PENDING</span>
                                    {% elif order.status == 'processing' %}
                                        <span class="badge-d365 info" style="font-size: 11px;">PROCESSING</span>
                                    {% elif order.status == 'shipped' %}
                                        <span class="badge-d365 info" style="font-size: 11px;">SHIPPED</span>
                                    {% elif order.status == 'delivered' %}
                                        <span class="badge-d365 success" style="font-size: 11px;">DELIVERED</span>
                                    {% elif order.status == 'cancelled' %}
                                        <span class="badge-d365 danger" style="font-size: 11px;">CANCELLED</span>
                                    {% else %}
                                        <span class="badge-d365 info" style="font-size: 11px;">{{ order.status|upper }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.payment_status == 'completed' or order.payment_status == 'paid' %}
                                        <span class="badge-d365 success" style="font-size: 11px;">PAID</span>
                                    {% elif order.payment_status == 'pending' %}
                                        <span class="badge-d365 warning" style="font-size: 11px;">PENDING</span>
                                    {% elif order.payment_status == 'unpaid' or order.payment_status == 'failed' %}
                                        <span class="badge-d365 danger" style="font-size: 11px;">UNPAID</span>
                                    {% else %}
                                        <span class="badge-d365 warning" style="font-size: 11px;">{{ order.payment_status|upper }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination -->
                {% if orders.pages > 1 %}
                    <div style="padding: 12px 16px; border-top: 1px solid #4A4A4A; display: flex; justify-content: center; align-items: center; gap: 8px;">
                        {% if orders.has_prev %}
                            <a href="?page={{ "{:,}".format(orders.prev_num) }}&status={{ current_status }}" class="btn-d365-secondary" style="padding: 4px 8px; font-size: 11px;">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        {% endif %}
                        <span style="font-size: 12px; color: #C0C0C0;">Page {{ "{:,}".format(orders.page) }} of {{ "{:,}".format(orders.pages) }}</span>
                        {% if orders.has_next %}
                            <a href="?page={{ "{:,}".format(orders.next_num) }}&status={{ current_status }}" class="btn-d365-secondary" style="padding: 4px 8px; font-size: 11px;">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <div style="text-align: center; padding: 48px; color: #808080;">
                    <i class="fas fa-shopping-bag" style="font-size: 36px; margin-bottom: 12px; display: block; opacity: 0.3;"></i>
                    <p style="margin: 0; font-size: 13px;">No orders found matching the selected filter.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer Info -->
    <div style="margin-top: 12px; font-size: 12px; color: #C0C0C0;">
        <span>Total records: {{ "{:,}".format(orders.total) }}</span>
    </div>
</div>

<style>
    .dashboard-container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        background: #1C1C1C !important;
    }

    .content {
        background: #1C1C1C !important;
        padding: 16px 24px !important;
    }
</style>

<script>
// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add change event to all checkboxes
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
            updateCommandBar();
        });
    });
    
    // Select All Checkbox
    document.getElementById('selectAll')?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(cb => {
            cb.checked = this.checked;
            const row = cb.closest('tr');
            if (this.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
        updateCommandBar();
    });
    
    // Initial update
    updateCommandBar();
});

// Row Selection
function selectRow(row, event) {
    if (event.target.type === 'checkbox' || event.target.tagName === 'A') return;
    const checkbox = row.querySelector('.row-select');
    checkbox.checked = !checkbox.checked;
    if (checkbox.checked) {
        row.classList.add('selected');
    } else {
        row.classList.remove('selected');
    }
    updateCommandBar();
}

// Update Command Bar based on selection
function updateCommandBar() {
    const selectedCount = document.querySelectorAll('.row-select:checked').length;
    const viewBtn = document.querySelector('.command-bar-left button:nth-child(1)');
    const updateBtn = document.querySelector('.command-bar-left button:nth-child(2)');
    
    if (selectedCount > 0) {
        viewBtn.disabled = selectedCount !== 1;
        updateBtn.disabled = false;
    } else {
        viewBtn.disabled = true;
        updateBtn.disabled = true;
    }
}

// Filter functionality
document.getElementById('filterInput')?.addEventListener('input', function(e) {
    const filter = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.table-d365 tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});
</script>
{% endblock %}
